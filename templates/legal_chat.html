<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap');

        :root {
            --bg: #0b1624;
            --panel: #0f2436;
            --card: #132b3f;
            --card-2: #102232;
            --accent: #00c2a8;
            --accent-2: #f7b733;
            --text: #e8edf2;
            --muted: #9fb3c8;
            --border: rgba(255, 255, 255, 0.06);
            --shadow: 0 20px 40px rgba(0,0,0,0.35);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Manrope', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 20% 20%, #16324f 0%, #0c1b2a 35%, #0b1624 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .app-shell {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .topbar {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, #0bc6ab, #0a9a9a);
            display: grid;
            place-items: center;
            font-size: 22px;
            box-shadow: var(--shadow);
        }

        .brand-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .brand-text p {
            color: var(--muted);
            font-size: 14px;
        }

        .mode-switch {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 6px;
            display: inline-flex;
            gap: 6px;
            box-shadow: var(--shadow);
        }

        .mode-switch button {
            border: none;
            background: transparent;
            color: var(--muted);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-switch button.active {
            background: linear-gradient(135deg, #0bc6ab, #15b58c);
            color: #05121c;
            box-shadow: 0 10px 30px rgba(11, 198, 171, 0.35);
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
        .btn.ghost { background: transparent; }
        .btn.accent { background: linear-gradient(135deg, #f7b733, #f5851f); color: #0b1624; border: none; }

        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 18px;
        }

        .chat-panel {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 12px;
        }

        .chat-feed {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            overflow-y: auto;
            max-height: calc(80vh - 120px);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: flex-start;
        }

        .message .avatar {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            font-size: 18px;
            background: var(--card-2);
            border: 1px solid var(--border);
        }

        .bubble {
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--card-2);
            line-height: 1.5;
        }

        .bubble.user {
            background: linear-gradient(135deg, #0f7cbf, #0ad0c7);
            color: #04101c;
            font-weight: 600;
        }

        .bubble .meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .pill.rag { background: rgba(11, 198, 171, 0.15); color: #4ce3c9; border: 1px solid rgba(76, 227, 201, 0.25); }
        .pill.gpt { background: rgba(247, 183, 51, 0.16); color: #f7b733; border: 1px solid rgba(247, 183, 51, 0.3); }
        .pill.auto { background: rgba(255,255,255,0.08); color: var(--muted); border: 1px solid var(--border); }

        .time {
            color: var(--muted);
            font-size: 12px;
        }

        .sources-inline {
            margin-top: 10px;
            padding: 10px;
            border-radius: 12px;
            background: rgba(11, 198, 171, 0.08);
            border: 1px dashed rgba(11, 198, 171, 0.35);
        }

        .sources-inline h4 { margin-bottom: 8px; font-size: 13px; color: #5ce7d1; }
        .sources-inline li { margin-left: 16px; color: var(--text); }

        .typing {
            display: none;
            color: var(--muted);
            padding: 6px 4px;
        }

        .composer {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        textarea {
            width: 100%;
            min-height: 54px;
            max-height: 140px;
            background: var(--card-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            padding: 12px;
            resize: none;
            font-size: 16px;
            line-height: 1.4;
            outline: none;
        }

        textarea:focus { border-color: rgba(0,194,168,0.4); box-shadow: 0 0 0 3px rgba(0,194,168,0.15); }

        .send-btn {
            background: linear-gradient(135deg, #0bc6ab, #15b58c);
            color: #05121c;
            border: none;
            padding: 14px 18px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            min-width: 130px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 10px 40px rgba(11, 198, 171, 0.25);
            transition: transform 0.1s ease;
        }

        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn:hover { transform: translateY(-1px); }

        .context-panel {
            display: grid;
            gap: 12px;
            align-content: start;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }

        .card h3 { margin-bottom: 8px; }
        .muted { color: var(--muted); }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .stat {
            background: var(--card-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        .stat .label { color: var(--muted); font-size: 12px; }
        .stat .value { font-size: 20px; font-weight: 800; margin-top: 4px; }

        .list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .list-item {
            padding: 10px;
            background: var(--card-2);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .list-item small { color: var(--muted); }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .chip {
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text);
        }

        .chip:hover { border-color: rgba(0,194,168,0.4); color: #6ef1dd; }

        .empty {
            color: var(--muted);
            font-size: 14px;
            padding: 8px 0;
        }

        @media (max-width: 1024px) {
            .layout { grid-template-columns: 1fr; }
            .topbar { grid-template-columns: 1fr; }
            .actions { justify-content: flex-start; flex-wrap: wrap; }
            .chat-feed { max-height: none; min-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="topbar">
            <div class="brand">
                <div class="logo">‚öñÔ∏è</div>
                <div class="brand-text">
                    <h1>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
                    <p>RAG –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç–≤–µ—Ç–æ–≤</p>
                </div>
            </div>
            <div class="mode-switch" id="modeSwitch">
                <button data-mode="auto" class="active">üîÄ –ê–≤—Ç–æ</button>
                <button data-mode="legal">üìö RAG</button>
                <button data-mode="general">üí¨ GPT</button>
            </div>
            <div class="actions">
                <button class="btn ghost" onclick="refreshStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="btn ghost" onclick="exportChat()">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn accent" onclick="clearHistory()">üîÑ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</button>
            </div>
        </header>

        <div class="layout">
            <section class="panel chat-panel">
                <div class="chat-feed" id="chatMessages">
                    <div class="message">
                        <div class="avatar">ü§ñ</div>
                        <div class="bubble">
                            <div class="meta">
                                <span class="pill rag">RAG</span>
                                <span class="time">–≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
                            </div>
                            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ. 
                            –í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω—ã –∫ –∫–∞–∂–¥–æ–º—É –æ—Ç–≤–µ—Ç—É.
                        </div>
                    </div>
                </div>
                <div class="typing" id="typingIndicator">AI –Ω–∞–±–∏—Ä–∞–µ—Ç –æ—Ç–≤–µ—Ç‚Ä¶</div>
                <div class="composer">
                    <div>
                        <textarea id="messageInput" rows="2" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–æ–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—é‚Ä¶" maxlength="1200"></textarea>
                        <div class="chips">
                            <span class="chip" onclick="usePrompt('–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç—Ä—É–¥–æ–≤–æ–º—É –¥–æ–≥–æ–≤–æ—Ä—É –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ?')">–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä</span>
                            <span class="chip" onclick="usePrompt('–ü—Ä–∞–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –†–ö')">–ü—Ä–∞–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞</span>
                            <span class="chip" onclick="usePrompt('–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ?')">–ù–∞—Å–ª–µ–¥—Å—Ç–≤–æ</span>
                            <span class="chip" onclick="usePrompt('–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –ø—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏ –ø–æ –¢–ö –†–ö')">–£–≤–æ–ª—å–Ω–µ–Ω–∏–µ</span>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span> üöÄ
                    </button>
                </div>
            </section>

            <aside class="context-panel">
                <div class="card">
                    <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
                    <p class="muted">–î–∞–Ω–Ω—ã–µ Pinecone –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã RAG</p>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="label">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å–µ</div>
                            <div class="value" id="statVectors">{{ stats.total_vectors or 0 }}</div>
                        </div>
                        <div class="stat">
                            <div class="label">–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–≤</div>
                            <div class="value" id="statDim">{{ stats.index_dimension or 0 }}</div>
                        </div>
                        <div class="stat">
                            <div class="label">–ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
                            <div class="value" id="statContext">‚Äì</div>
                        </div>
                        <div class="stat">
                            <div class="label">–†–µ–∂–∏–º</div>
                            <div class="value" id="statMode">Auto</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—Ç–≤–µ—Ç–∞</h3>
                    <p class="muted">–§—Ä–∞–≥–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
                    <div class="list" id="sourcesList">
                        <div class="empty">–û—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.</div>
                    </div>
                </div>

                <div class="card">
                    <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã</h3>
                    <p class="muted">–°–Ω–∏–ø–ø–µ—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ (RAG)</p>
                    <div class="list" id="resultsList">
                        <div class="empty">–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const modeButtons = document.querySelectorAll('#modeSwitch button');

        const state = {
            mode: 'auto',
            lastSources: [],
            lastResults: []
        };

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => setMode(btn.dataset.mode));
        });

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 140) + 'px';
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function setMode(mode) {
            state.mode = mode;
            modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
            document.getElementById('statMode').textContent = mode === 'auto' ? 'Auto' : (mode === 'legal' ? 'RAG' : 'GPT');
        }

        function usePrompt(text) {
            messageInput.value = text;
            messageInput.focus();
        }

        function escapeHtml(str) {
            const safe = str === undefined || str === null ? '' : String(str);
            return safe.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
        }

        function addMessage(content, role = 'assistant', meta = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message';

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'üßë' : 'ü§ñ';

            const bubble = document.createElement('div');
            bubble.className = 'bubble' + (role === 'user' ? ' user' : '');

            if (role === 'assistant') {
                const metaRow = document.createElement('div');
                metaRow.className = 'meta';
                const pill = document.createElement('span');
                pill.className = 'pill ' + (meta.mode === 'legal_rag' ? 'rag' : meta.mode === 'general' ? 'gpt' : 'auto');
                pill.textContent = meta.mode === 'legal_rag' ? 'RAG' : 'GPT';
                const time = document.createElement('span');
                time.className = 'time';
                time.textContent = meta.time || new Date().toLocaleTimeString();
                metaRow.appendChild(pill);
                metaRow.appendChild(time);
                bubble.appendChild(metaRow);
            }

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
            bubble.appendChild(contentDiv);

            if (meta.sources && meta.sources.length > 0 && role === 'assistant') {
                const sourcesBox = document.createElement('div');
                sourcesBox.className = 'sources-inline';
                sourcesBox.innerHTML = '<h4>–ò—Å—Ç–æ—á–Ω–∏–∫–∏</h4><ul>' + meta.sources.map(s => `<li>${escapeHtml(s)}</li>`).join('') + '</ul>';
                bubble.appendChild(sourcesBox);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function renderContext(sources, results, meta = {}) {
            const sourcesList = document.getElementById('sourcesList');
            const resultsList = document.getElementById('resultsList');

            sourcesList.innerHTML = sources.length
                ? sources.map((s, idx) => `<div class="list-item"><small>–ò—Å—Ç–æ—á–Ω–∏–∫ ${idx + 1}</small><div>${escapeHtml(s)}</div></div>`).join('')
                : '<div class="empty">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞.</div>';

            resultsList.innerHTML = results.length
                ? results.map((r, idx) => `<div class="list-item"><small>–†–µ–∑—É–ª—å—Ç–∞—Ç ${idx + 1} ‚Ä¢ score: ${r.score?.toFixed ? r.score.toFixed(2) : r.score}</small><div>${escapeHtml(r.text || '')}</div><div class="muted">${escapeHtml(r.source || '')}</div></div>`).join('')
                : '<div class="empty">–ü–æ–∏—Å–∫–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞.</div>';

            document.getElementById('statContext').textContent = `${meta.results_count || 0} / ${meta.context_length || 0}`;
        }

        function setLoading(isLoading) {
            typingIndicator.style.display = isLoading ? 'block' : 'none';
            sendBtn.disabled = isLoading;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            setLoading(true);
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, mode: state.mode })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.answer, 'assistant', { mode: data.mode, sources: data.sources });
                    renderContext(data.sources || [], data.search_results || [], {
                        results_count: data.results_count,
                        context_length: data.context_length
                    });
                } else {
                    addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.', 'assistant', { mode: 'general' });
                }
            } catch (err) {
                addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', 'assistant', { mode: 'general' });
            } finally {
                setLoading(false);
                messageInput.focus();
            }
        }

        async function clearHistory() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥?')) return;
            await fetch('/clear', { method: 'POST' });
            chatMessages.innerHTML = '';
            addMessage('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–π—á–∞—Å?', 'assistant', { mode: 'legal_rag' });
            renderContext([], [], {});
        }

        async function exportChat() {
            const response = await fetch('/history');
            const data = await response.json();
            const text = data.history.map(msg => `${msg.role === 'user' ? '–í—ã' : 'AI'}: ${msg.content}`).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `legal_chat_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function refreshStats() {
            try {
                const res = await fetch('/stats');
                const stats = await res.json();
                if (res.ok) {
                    document.getElementById('statVectors').textContent = stats.total_vectors ?? '‚Äî';
                    document.getElementById('statDim').textContent = stats.index_dimension ?? '‚Äî';
                }
            } catch (_) {
                addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.', 'assistant', { mode: 'general' });
            }
        }

        renderContext([], [], {});
    </script>
</body>
</html>
